<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Switching Kalman Filter and Its Variants" /><meta name="author" content="Pavan Donthireddy" /><meta property="og:locale" content="en_US" /><meta name="description" content="This article explains the switching Kalman filter and its variants in detail. It also includes Python implementations of the algorithms." /><meta property="og:description" content="This article explains the switching Kalman filter and its variants in detail. It also includes Python implementations of the algorithms." /><link rel="canonical" href="http://localhost:4000/2023/04/22/switching-kalman-filter" /><meta property="og:url" content="http://localhost:4000/2023/04/22/switching-kalman-filter" /><meta property="og:site_name" content="Pavan Donthireddy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-22T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Switching Kalman Filter and Its Variants" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Pavan Donthireddy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Pavan Donthireddy"},"dateModified":"2023-04-22T00:00:00+01:00","datePublished":"2023-04-22T00:00:00+01:00","description":"This article explains the switching Kalman filter and its variants in detail. It also includes Python implementations of the algorithms.","headline":"Switching Kalman Filter and Its Variants","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2023/04/22/switching-kalman-filter"},"url":"http://localhost:4000/2023/04/22/switching-kalman-filter"}</script><title> Switching Kalman Filter and Its Variants - Pavan Donthireddy</title><meta charset="UTF-8"><link rel="canonical" href="http://localhost:4000/2023/04/22/switching-kalman-filter" /><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="IntroductionA Kalman filter is a widely used algorithm that provides optimal estimation of a state variable based on a series of noisy measurements. It makes..."><meta property="og:site_name" content="Pavan Donthireddy"><meta property="og:description" content="IntroductionA Kalman filter is a widely used algorithm that provides optimal estimation of a state variable based on a series of noisy measurements. It makes..."/><meta property="og:title" content="Switching Kalman Filter and Its Variants"><meta property="og:type" content="article"><meta property="article:published_time" content="2023-04-22T00:00:00+01:00"><meta property="article:author" content="http://localhost:4000/"><meta property="og:url" content="http://localhost:4000/2023/04/22/switching-kalman-filter" /><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="Pavan Donthireddy" href="/atom.xml"><link rel="alternate" type="application/json" title="Pavan Donthireddy" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ jax: ["input/TeX","input/MathML","output/SVG", "output/CommonHTML"], extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "CHTML-preview.js"], TeX: { extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"] }, tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true, processEnvironments: true, skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }, messageStyle: "none", "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }, TeX: { equationNumbers: { autoNumber: "AMS" }, extensions: ["AMSmath.js", "AMSsymbols.js","AMScd.js"], TagSide: "left", Macros: { field: ['\\mathbb{#1}', 1], C: ['\\field{C}'], E: ['\\field{E}'], F: ['\\field{F}'], N: ['\\field{N}'], P: ['\\field{P}'], Q: ['\\field{Q}'], R: ['\\field{R}'], Z: ['\\field{Z}'], ha : ['\\hat{#1}',1], Re: ['\\mathop{\\mathrm{Re}}'], Im: ['\\mathop{\\mathrm{Im}}'], Res: ['\\mathop{\\mathrm{Res}}'], } } }); </script> <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full"></script><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code,pre{background:#ecedee}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.post-archive{font-size:15px;line-height:2;padding-bottom:.8em}.post-archive .date{padding-right:.7em}.pagination{width:100%;padding:0 20px;text-align:center}.pagination ul{list-style:none}.pagination ul li{display:inline;margin:0 5px}.pagination ul li a{color:#000;text-decoration:none}.pagination ul li a:hover{color:gray;text-decoration:underline}.pagination ul li.current-page a{background:#ddd;color:#fff}.post-link{position:relative;display:inline-block}.post-excerpt{display:none;position:absolute;z-index:1;top:100%;left:0;width:100%;padding:10px;background-color:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1)}.post-link:hover .post-excerpt{display:block}.img-padding{width:200px;height:200px;padding:20px 20px 20px 20px}</style><link rel="stylesheet" href="/_includes/prism.css"> <script src="/assets/js/prism.js"></script></head><body><main role="main"><header role="banner"> <!--<h1 class="logo">Pavan Donthireddy</h1>--><nav role="navigation"><ul><li><a href="/" >Notes</a></li><li><a href="/tags" >Tags</a></li><li><a href="/search" >Search</a></li><li><a href="/about" >About</a></li></ul></nav></header><link rel="stylesheet" href="/assets/js/prism.css"> <script src="/assets/js/prism.js"></script><section class="post"> <script src="/assets/js/prism.js"></script><h1 style="text-align: center;">Switching Kalman Filter and Its Variants</h1><div style="text-align: center;"><span class="meta"><time datetime="2023-04-22T00:00:00+01:00">April 22, 2023</time> </span></div><div style="text-align: center;"><span class="meta"> <a href="/tag/kalman">kalman</a></span></div><h1 id="introduction">Introduction</h1><p>A Kalman filter is a widely used algorithm that provides optimal estimation of a state variable based on a series of noisy measurements. It makes use of the past measurements and uses them, along with the system dynamics, to predict the future state of the system. This predicted state is then compared with the actual measurement, and the filter generates an optimal estimation of the true state. However, the standard Kalman filter assumes that the underlying system behaves in a certain way, and if the assumption is incorrect, the filter may not perform optimally. In such cases, we need to switch between multiple Kalman filters to estimate the system state accurately. This article discusses the switching Kalman filter and its variants.</p><h1 id="switching-kalman-filter">Switching Kalman Filter</h1><p>A switching Kalman filter (SKF) is an extension of the standard Kalman filter that efficiently addresses the problem of switching between different models. The idea behind SKF is to use a set of different models that describe the different regimes of the system. In each regime, a different Kalman filter is used to estimate the system state.</p><p>Consider a system with <code class="language-plaintext highlighter-rouge">N</code> different regimes, and let <code class="language-plaintext highlighter-rouge">z_t</code> be a discrete random variable that takes values in <code class="language-plaintext highlighter-rouge">{1, 2, ..., N}</code> at time <code class="language-plaintext highlighter-rouge">t</code>, indicating which regime the system is currently in. Further, let <code class="language-plaintext highlighter-rouge">x_t</code> be the state of the system at time <code class="language-plaintext highlighter-rouge">t</code>, and <code class="language-plaintext highlighter-rouge">y_t</code> be the observation (measurement) of the system at time <code class="language-plaintext highlighter-rouge">t</code>. Assuming that the system transitions between regimes according to a Markov process, the state transition equation can be written as follows:</p>\[x_t = A_{z_t} x_{t-1} + w_t\]<p>where <code class="language-plaintext highlighter-rouge">w_t</code> is a zero-mean Gaussian noise with covariance <code class="language-plaintext highlighter-rouge">Q_{z_t}</code>. The observation equation is given by:</p>\[y_t = H_{z_t} x_t + v_t\]<p>where <code class="language-plaintext highlighter-rouge">v_t</code> is a zero-mean Gaussian noise with covariance <code class="language-plaintext highlighter-rouge">R_{z_t}</code>, and <code class="language-plaintext highlighter-rouge">A_i, H_i, Q_i, R_i</code> are the state model, observation model, process noise covariance, and measurement noise covariance, respectively, for regime <code class="language-plaintext highlighter-rouge">i</code>.</p><p>The SKF algorithm consists of two steps: (i) filtering, and (ii) mode estimation.</p><h2 id="filtering-with-switching-kalman-filter">Filtering with switching Kalman Filter</h2><p>In the first step, we use a set of Kalman filters to filter the observations <code class="language-plaintext highlighter-rouge">y_t</code> and estimate the state <code class="language-plaintext highlighter-rouge">x_t</code> in each regime. Suppose we have <code class="language-plaintext highlighter-rouge">N</code> different Kalman filters, each corresponding to a different regime. For each regime <code class="language-plaintext highlighter-rouge">i</code>, the Kalman filter consists of the following equations:</p><p><strong>Prediction step:</strong></p>\[\hat{x}_{t|t-1}^{(i)} = A_{i} \hat{x}_{t-1|t-1}^{(i)}\] \[P_{t|t-1}^{(i)} = A_{i} P_{t-1|t-1}^{(i)} A_{i}^T + Q_{i}\]<p><strong>Update step:</strong></p>\[K_t^{(i)} = P_{t|t-1}^{(i)} H_{i}^T [H_{i} P_{t|t-1}^{(i)} H_{i}^T + R_{i}]^{-1}\] \[\hat{x}_{t|t}^{(i)} = \hat{x}_{t|t-1}^{(i)} + K_t^{(i)} (y_t - H_{i} \hat{x}_{t|t-1}^{(i)})\] \[P_{t|t}^{(i)} = (I - K_t^{(i)} H_{i}) P_{t|t-1}^{(i)}\]<p>Here, <code class="language-plaintext highlighter-rouge">P_{t|t}^{(i)}</code> is the error covariance matrix of the Kalman filter for regime <code class="language-plaintext highlighter-rouge">i</code> at time <code class="language-plaintext highlighter-rouge">t</code>, <code class="language-plaintext highlighter-rouge">K_t^{(i)}</code> is the Kalman gain matrix, and <code class="language-plaintext highlighter-rouge">y_t</code> is the observation at time <code class="language-plaintext highlighter-rouge">t</code>.</p><h2 id="mode-estimation">Mode Estimation</h2><p>Once we have the estimated state <code class="language-plaintext highlighter-rouge">x_t</code> and error covariance matrix <code class="language-plaintext highlighter-rouge">P_{t|t}^{(i)}</code> for each regime, we need to estimate the mode <code class="language-plaintext highlighter-rouge">z_t</code> of the system, which tells us which regime the system is currently in. This is done using Bayesian model selection. We estimate the posterior probability of each model given the observations up to time <code class="language-plaintext highlighter-rouge">t</code>:</p>\[P(z_t = i | y_{1:t}) = \frac{P(y_{1:t}|z_t=i)P(z_t=i)}{\sum_{j=1}^N P(y_{1:t}|z_t=j)P(z_t=j)}\]<p>where <code class="language-plaintext highlighter-rouge">P(z_t=i)</code> is the prior probability of regime <code class="language-plaintext highlighter-rouge">i</code>, and <code class="language-plaintext highlighter-rouge">P(y_{1:t}|z_t=i)</code> is the likelihood of the observations up to time <code class="language-plaintext highlighter-rouge">t</code> given that the system is in regime <code class="language-plaintext highlighter-rouge">i</code>. The prior probabilities can be set uniformly, i.e., <code class="language-plaintext highlighter-rouge">P(z_t=i) = 1/N</code>.</p><p>The likelihood can be computed using the Kalman filter prediction and update steps as follows:</p>\[P(y_{1:t}|z_t=i) = \int P(y_t|x_t) P(x_t|x_{t-1}, z_t=i)dx_t\]<p>where <code class="language-plaintext highlighter-rouge">P(x_t|x_{t-1}, z_t=i)</code> is the state transition probability for regime <code class="language-plaintext highlighter-rouge">i</code>, and <code class="language-plaintext highlighter-rouge">P(y_t|x_t)</code> is the observation probability. These probabilities are given by the state model and observation model for each regime.</p><p>Once we have computed the posterior probabilities, the mode <code class="language-plaintext highlighter-rouge">z_t</code> can be estimated as:</p>\[\hat{z}_t = \arg\max_{i=1}^N P(z_t=i|y_{1:t})\]<h1 id="variants-of-switching-kalman-filter">Variants of Switching Kalman Filter</h1><p>The SKF algorithm described above assumes that the models for different regimes are known a priori. In practice, the models may not be known, or they may change over time. To address these issues, several variants of SKF have been proposed.</p><h2 id="adaptive-switching-kalman-filter">Adaptive Switching Kalman Filter</h2><p>The adaptive switching Kalman filter (ASKF) is a variant of SKF that adapts to changes in the system. It is based on the assumption that the parameters of the different regimes may change slowly over time. The ASKF estimates the parameters of each regime using a recursive least-squares algorithm and updates them periodically.</p><p>The state transition equation for the ASKF can be written as:</p>\[x_t = A_{\theta_t} x_{t-1} + w_t\]<p>where <code class="language-plaintext highlighter-rouge">A_{\theta_t}</code> is the state model parameterized by a vector <code class="language-plaintext highlighter-rouge">theta_t</code>. The observation equation is the same as that for SKF.</p><p>The ASKF algorithm consists of the following steps:</p><ol><li>Initialize the state <code class="language-plaintext highlighter-rouge">x_0</code> and the error covariance matrix <code class="language-plaintext highlighter-rouge">P_0</code>.</li><li>For each regime <code class="language-plaintext highlighter-rouge">i</code>, initialize the state model parameters <code class="language-plaintext highlighter-rouge">theta_i</code> using a set of prior values.</li><li>For each time step <code class="language-plaintext highlighter-rouge">t</code>, do the following: a. Using the current mode estimate <code class="language-plaintext highlighter-rouge">z_t</code>, compute the Kalman filter prediction and update as described above. b. Update the state model parameters for each regime using a recursive least-squares algorithm. c. Compute the posterior probabilities and estimate the mode <code class="language-plaintext highlighter-rouge">z_t</code> as described above.</li></ol><p>The recursive least-squares algorithm updates the state model parameters <code class="language-plaintext highlighter-rouge">theta_t^{(i)}</code> as follows:</p>\[\theta_t^{(i)} = \theta_{t-1}^{(i)} + K_t^{(i)}[y_t - H_i \hat{x}_{t|t-1}^{(i)}]x_{t-1}^T\]<p>where <code class="language-plaintext highlighter-rouge">K_t^{(i)}</code> is the Kalman gain matrix for regime <code class="language-plaintext highlighter-rouge">i</code>, and <code class="language-plaintext highlighter-rouge">x_{t-1}</code> is the state at time <code class="language-plaintext highlighter-rouge">t-1</code>. The error covariance of the parameter estimate is updated as follows:</p>\[P_{\theta,t}^{(i)} = P_{\theta,t-1}^{(i)} - K_t^{(i)} [H_i P_{t|t-1}^{(i)} H_i^T + R_i] K_t^{(i)T}\]<p>The state model parameters can also be regularized to prevent overfitting.</p><h2 id="particle-switching-kalman-filter">Particle Switching Kalman Filter</h2><p>The particle filtering approach to the SKF is called the particle switching Kalman filter (PSKF). In the PSKF, we use a set of particle filters instead of Kalman filters to estimate the state in each regime. Particle filtering is a non-parametric approach to filtering that approximates the posterior distribution of the state using a set of weighted particles.</p><p>The PSKF algorithm consists of the following steps:</p><ol><li>Initialize a set of <code class="language-plaintext highlighter-rouge">M</code> particles for each regime.</li><li>For each time step <code class="language-plaintext highlighter-rouge">t</code>, do the following: a. For each regime <code class="language-plaintext highlighter-rouge">i</code>, propagate the particles using the state transition equation and compute the weights based on the observation model. b. Resample the particles with replacement based on their weights, and compute the Kalman filter prediction and update for each regime. c. Compute the posterior probabilities and estimate the mode <code class="language-plaintext highlighter-rouge">z_t</code> as described above.</li></ol><p>The PSKF has several advantages over the SKF. It can handle non-linear and non-Gaussian models and does not make any assumptions about the system dynamics. However, it is computationally expensive and requires a large number of particles to get accurate estimates.</p><h1 id="implementation-in-python">Implementation in Python</h1><p>In this section, we provide an implementation of the SKF algorithm in Python using NumPy and SciPy. We assume that the state and observation models for each regime are known a priori.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">multivariate_normal</span>

<span class="k">class</span> <span class="nc">KalmanFilter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">P0</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span>
        <span class="n">self</span><span class="p">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">H</span>
        <span class="n">self</span><span class="p">.</span><span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span>
        <span class="n">self</span><span class="p">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">self</span><span class="p">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">P0</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">A</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span>
        <span class="n">self</span><span class="p">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">A</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">P</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">A</span><span class="p">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">Q</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">P</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">H</span><span class="p">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">H</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">P</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">H</span><span class="p">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">self</span><span class="p">.</span><span class="n">R</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">K</span> <span class="o">@</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="n">H</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">K</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">H</span><span class="p">)</span> <span class="o">@</span> <span class="n">self</span><span class="p">.</span><span class="n">P</span>

<span class="k">class</span> <span class="nc">SwitchingKalmanFilter</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">Pz0</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">models</span>
        <span class="n">self</span><span class="p">.</span><span class="n">N</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">N</span> <span class="k">if</span> <span class="n">Pz0</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">Pz0</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">model</span><span class="p">.</span><span class="nf">predict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">update</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">compute_posterior</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">compute_posterior</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">likelihoods</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">multivariate_normal</span><span class="p">.</span><span class="nf">pdf</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">P</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">)</span>
            <span class="n">likelihoods</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">Pz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">prob</span>
        <span class="n">self</span><span class="p">.</span><span class="n">Pz</span> <span class="o">=</span> <span class="n">likelihoods</span> <span class="o">/</span> <span class="n">likelihoods</span><span class="p">.</span><span class="nf">sum</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">Pz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">get_error_cov</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">P</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">-</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_state</span><span class="p">()</span>
            <span class="n">P</span> <span class="o">+=</span> <span class="n">self</span><span class="p">.</span><span class="n">Pz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">P</span> <span class="o">+</span> <span class="n">d</span> <span class="o">@</span> <span class="n">d</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]])</span>
    <span class="n">H1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">Q1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]])</span>
    <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">x01</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">P01</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">A2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.9</span><span class="p">]])</span>
    <span class="n">H2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">Q2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]])</span>
    <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">x02</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">P02</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nc">KalmanFilter</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">H1</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">x01</span><span class="p">,</span> <span class="n">P01</span><span class="p">),</span>
        <span class="nc">KalmanFilter</span><span class="p">(</span><span class="n">A2</span><span class="p">,</span> <span class="n">H2</span><span class="p">,</span> <span class="n">Q2</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">x02</span><span class="p">,</span> <span class="n">P02</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">skf</span> <span class="o">=</span> <span class="nc">SwitchingKalmanFilter</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">R1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
        <span class="n">skf</span><span class="p">.</span><span class="nf">predict</span><span class="p">()</span>
        <span class="n">skf</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

    <span class="nf">print</span><span class="p">(</span><span class="n">skf</span><span class="p">.</span><span class="nf">get_state</span><span class="p">())</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">skf</span><span class="p">.</span><span class="nf">get_error_cov</span><span class="p">())</span>
</code></pre></div></div><p>This is a simple example of SKF with two regimes, where the state model and observation model for each regime are the same. We define the <code class="language-plaintext highlighter-rouge">KalmanFilter</code> class to represent the Kalman filter for each regime and the <code class="language-plaintext highlighter-rouge">SwitchingKalmanFilter</code> class to represent the SKF. The functions <code class="language-plaintext highlighter-rouge">predict</code> and <code class="language-plaintext highlighter-rouge">update</code> implement the Kalman filter prediction and update steps, and <code class="language-plaintext highlighter-rouge">compute_posterior</code> computes the posterior probabilities of each regime.</p><p>In the <code class="language-plaintext highlighter-rouge">main</code> function, we define two regimes with different state models and observation models, and we use SKF to estimate the system state based on noisy measurements. We generate the measurements using a Gaussian distribution with mean <code class="language-plaintext highlighter-rouge">0</code> and covariance <code class="language-plaintext highlighter-rouge">R1</code>. Finally, we print the estimated state and error covariance.</p><hr> <side style="font-size: 0.9em"><h3 style="margin-bottom: 1em">Notes mentioning this note</h3><div style="font-size: 0.9em"><p> There are no notes linking to this note.</p></div></side> <a href="" class="post-link"><h2></h2><p class="post-excerpt"></p></a> <script src="https://giscus.app/client.js" data-repo="pavandonthireddy/pavandonthireddy.github.io" data-repo-id="[ENTER REPO ID HERE]" data-category="[ENTER CATEGORY NAME HERE]" data-category-id="[ENTER CATEGORY ID HERE]" data-mapping="url" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light_high_contrast" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></section></main></body></html>
